# ════════════════════════════════════════════════════════════════
# NGINX REVERSE PROXY FOR VAULT
# ════════════════════════════════════════════════════════════════
# Este archivo configura Nginx como reverse proxy para Vault con:
# - TLS/SSL termination
# - HTTP/2
# - Security headers
# - Health checks
# ════════════════════════════════════════════════════════════════

events {
    worker_connections 1024;
}

http {
    # ────────────────────────────────────────────────────────────
    # LOGS
    # ────────────────────────────────────────────────────────────
    
    log_format vault_format '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $body_bytes_sent '
                           '"$http_referer" "$http_user_agent" '
                           'rt=$request_time uct="$upstream_connect_time" '
                           'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    access_log /var/log/nginx/access.log vault_format;
    error_log /var/log/nginx/error.log warn;
    
    # ────────────────────────────────────────────────────────────
    # UPSTREAM - Vault Backend
    # ────────────────────────────────────────────────────────────
    
    upstream vault_backend {
        # Single node
        server vault:8200 max_fails=3 fail_timeout=30s;
        
        # Multi-node (si expandes a cluster):
        # server vault-1:8200 max_fails=3 fail_timeout=30s;
        # server vault-2:8200 max_fails=3 fail_timeout=30s;
        # server vault-3:8200 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # ────────────────────────────────────────────────────────────
    # HTTP → HTTPS REDIRECT
    # ────────────────────────────────────────────────────────────
    
    server {
        listen 80;
        listen [::]:80;
        server_name vault.company.com;
        
        # Redirect HTTP to HTTPS
        return 301 https://$server_name$request_uri;
    }
    
    # ────────────────────────────────────────────────────────────
    # HTTPS SERVER
    # ────────────────────────────────────────────────────────────
    
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name vault.company.com;
        
        # ┌────────────────────────────────────────────────────────┐
        # │ TLS/SSL CONFIGURATION                                  │
        # └────────────────────────────────────────────────────────┘
        
        ssl_certificate /etc/nginx/tls/vault-cert.pem;
        ssl_certificate_key /etc/nginx/tls/vault-key.pem;
        
        # Protocolo TLS 1.2 y 1.3 solamente
        ssl_protocols TLSv1.2 TLSv1.3;
        
        # Suites de cifrado fuertes
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers on;
        
        # OCSP Stapling
        ssl_stapling on;
        ssl_stapling_verify on;
        
        # Session tickets
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;
        
        # ┌────────────────────────────────────────────────────────┐
        # │ SECURITY HEADERS                                        │
        # └────────────────────────────────────────────────────────┘
        
        # HSTS (63072000 segundos = 2 años)
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        
        # Prevent clickjacking
        add_header X-Frame-Options "DENY" always;
        
        # Prevent MIME sniffing
        add_header X-Content-Type-Options "nosniff" always;
        
        # XSS Protection
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Referrer policy
        add_header Referrer-Policy "no-referrer" always;
        
        # Content Security Policy (ajusta según necesidad)
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self';" always;
        
        # ┌────────────────────────────────────────────────────────┐
        # │ TIMEOUTS Y BUFFERING                                    │
        # └────────────────────────────────────────────────────────┘
        
        client_max_body_size 50M;
        client_body_buffer_size 128k;
        
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
        
        # ┌────────────────────────────────────────────────────────┐
        # │ PROXY CONFIGURATION                                     │
        # └────────────────────────────────────────────────────────┘
        
        location / {
            proxy_pass http://vault_backend;
            
            # Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # WebSocket support (para UI)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # No buffer para streaming responses
            proxy_buffering off;
            
            # Preservar cookies
            proxy_set_header Cookie $http_cookie;
        }
        
        # ┌────────────────────────────────────────────────────────┐
        # │ HEALTH CHECK ENDPOINT                                   │
        # └────────────────────────────────────────────────────────┘
        
        location /health {
            access_log off;
            
            proxy_pass http://vault_backend/v1/sys/health?standbyok=true;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Health check no debe fallar por unsealed
            proxy_intercept_errors off;
        }
        
        # ┌────────────────────────────────────────────────────────┐
        # │ RATE LIMITING (Opcional)                               │
        # └────────────────────────────────────────────────────────┘
        
        # Descomentar para habilitar rate limiting
        # limit_req_zone $binary_remote_addr zone=vault_limit:10m rate=100r/s;
        # limit_req zone=vault_limit burst=200 nodelay;
    }
}

# ════════════════════════════════════════════════════════════════
# NOTAS DE CONFIGURACIÓN
# ════════════════════════════════════════════════════════════════
#
# 1. CERTIFICADOS TLS:
#    - Coloca certificados en ./nginx/tls/
#    - vault-cert.pem: Certificado SSL
#    - vault-key.pem: Llave privada
#    - ca.pem: CA certificate (opcional)
#
# 2. GENERAR CERTIFICADOS (Desarrollo):
#    openssl req -x509 -newkey rsa:4096 -nodes \
#      -keyout nginx/tls/vault-key.pem \
#      -out nginx/tls/vault-cert.pem \
#      -days 365 -subj "/CN=vault.company.com"
#
# 3. PRODUCCIÓN:
#    - Usa Let's Encrypt con certbot
#    - O certificados de tu CA interna
#
# 4. ACTIVAR EN DOCKER-COMPOSE:
#    docker-compose --profile with-nginx up -d
#
# 5. DNS:
#    - Configurar vault.company.com → IP del servidor
#
# 6. TESTING:
#    curl -k https://vault.company.com/health
#
# ════════════════════════════════════════════════════════════════
